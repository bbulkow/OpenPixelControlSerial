# WLED Configuration Tool

A command-line tool to configure WLED devices over serial port using the WLED JSON API.

## Overview

This tool allows you to configure WLED devices connected via serial port without using the web interface. This is particularly useful when setting up multiple devices, as the web interface can be cumbersome for bulk operations.

## Primary Use Case

**LIVE Mode Control**: WLED devices ship with patterns/effects enabled by default and LIVE mode disabled. When LIVE mode is disabled, the device will not respond to serial LED data (Adalight/AWA protocols). This tool allows you to quickly enable LIVE mode on one or more devices to prepare them for receiving real-time LED data.

## Features

- **Automatic Device Detection**: Reads `config.json` to find WLED devices
- **LIVE Mode Control**: Enable or disable LIVE mode via JSON API
- **Multiple Interfaces**:
  - Command-line for scripting and automation
  - Interactive menu for manual configuration
- **Cross-Platform**: Works on Windows, Linux, and macOS
- **Multi-Device Support**: Configure single device, specific port, or all devices at once
- **Verification**: Queries device state before and after changes

## Requirements

- Python 3.6 or later
- pyserial library
- WLED device connected via USB/serial port
- Configuration file (generated by `discover.py`)

## Installation

```bash
cd wled-config
pip install -r requirements.txt
```

## Usage

### Interactive Mode (Default)

Run without arguments to enter interactive mode:

```bash
python wled_config.py
```

Interactive mode provides a menu to:
- View all WLED devices and their current LIVE mode status
- Select individual devices to configure
- Enable/disable LIVE mode on selected devices
- Configure all devices at once
- Query full device state (JSON output)

### Command-Line Mode

Enable LIVE mode on all WLED devices:
```bash
python wled_config.py --enable-live
```

Disable LIVE mode on all WLED devices:
```bash
python wled_config.py --disable-live
```

Configure specific device by port:
```bash
python wled_config.py --port COM4 --enable-live
python wled_config.py --port /dev/ttyUSB0 --disable-live
```

Use alternate configuration file:
```bash
python wled_config.py --config myconfig.json --enable-live
```

Enable debug output:
```bash
python wled_config.py --debug --enable-live
```

### Command-Line Options

```
Options:
  -h, --help            Show help message and exit
  --config PATH, -c PATH
                        Configuration file path (default: config.json)
  --port PORT, -p PORT  Serial port name (e.g., COM4, /dev/ttyUSB0)
  --enable-live         Enable LIVE mode on device(s)
  --disable-live        Disable LIVE mode on device(s)
  --interactive, -i     Interactive mode (default if no action specified)
  --debug, -d           Enable debug output
```

## Configuration File

The tool reads WLED device information from a `config.json` file. This file should be generated using the `discover.py` script, which automatically detects WLED devices and creates the configuration.

Example configuration structure:
```json
{
  "opc": {
    "host": "0.0.0.0",
    "port": 7890
  },
  "outputs": [
    {
      "port": "COM4",
      "protocol": "adalight",
      "device_type": "WLED",
      "device_name": "WLED Controller",
      "wled_version": "0.14.0",
      "led_count": 300,
      "pixel_format": "GRB"
    }
  ]
}
```

The tool identifies WLED devices by looking for:
- `device_type`: "WLED"
- Presence of `wled_version`, `wled_brand`, or `wled_product` keys

## How It Works

### WLED JSON API over Serial

WLED devices support a JSON API that can be accessed over:
- HTTP (web interface)
- WebSocket
- **Serial port** (what this tool uses)

The serial JSON API operates at **115200 baud** (fixed) regardless of the baud rate used for LED data transmission (which may be higher for AWA protocol).

### LIVE Mode

LIVE mode determines whether the device accepts real-time LED data via serial protocols:

- **LIVE Mode ENABLED**: Device accepts Adalight/AWA/TPM2 serial LED data
- **LIVE Mode DISABLED**: Device runs internal effects/patterns, ignores serial LED data

### Commands Used

The tool sends JSON commands to WLED devices:

**Query device state**:
```json
{"v":true}
```

**Enable LIVE mode**:
```json
{"state":{"live":true}}
```

**Disable LIVE mode**:
```json
{"state":{"live":false}}
```

## Typical Workflow

1. **Discover devices**:
   ```bash
   cd ../discover
   python discover.py
   ```

2. **Check which devices need LIVE mode enabled**:
   ```bash
   cd ../wled-config
   python wled_config.py
   # Interactive menu will show current LIVE status
   ```

3. **Enable LIVE mode** on all devices:
   ```bash
   python wled_config.py --enable-live
   ```

4. **Verify** the change was applied:
   ```bash
   python wled_config.py
   # Check status in interactive menu
   ```

## Troubleshooting

### "No WLED devices found in configuration"

- Run `discover.py` first to detect devices and generate `config.json`
- Ensure WLED devices are connected and powered on
- Check that the configuration file is in the expected location

### "Cannot open serial port"

- Ensure no other application is using the serial port
- Check port permissions on Linux/macOS: `sudo chmod 666 /dev/ttyUSB0`
- Verify the device is still connected

### "No response from device"

- Check that the device is powered on and connected
- Try unplugging and reconnecting the device
- Ensure the correct port is specified
- Some WLED devices may need to be reset after changing LIVE mode

### "LIVE mode verification failed"

- The device may have rebooted after the change (this is normal for some WLED versions)
- Wait a few seconds and query again to verify
- Try using `--debug` flag to see detailed communication

## Platform-Specific Notes

### Windows
- Serial ports are named `COM1`, `COM2`, etc.
- No special permissions needed

### Linux
- Serial ports are typically `/dev/ttyUSB0`, `/dev/ttyACM0`, etc.
- May need to add user to `dialout` group: `sudo usermod -a -G dialout $USER`
- Or temporarily grant permissions: `sudo chmod 666 /dev/ttyUSB0`

### macOS
- Serial ports are typically `/dev/cu.usbserial-*` or `/dev/cu.usbmodem-*`
- No special permissions usually needed

## Related Tools

- **discover.py**: Detects LED devices and generates configuration
- **opc-server**: OPC server that sends LED data to devices
- **validate.py**: Validates configuration files

## Future Enhancements

Planned features for future releases:
- LED strip configuration (count, type, GPIO pins)
- Brightness control
- Effect presets
- Network configuration
- Multiple WLED segments support

## Technical Details

- **Serial Protocol**: WLED JSON API over UART
- **Baud Rate**: 115200 (fixed for JSON API)
- **Timeout**: 1 second for serial operations
- **Verification**: Changes are verified by re-querying device state

## License

Part of the OpenPixelControlSerial project.
